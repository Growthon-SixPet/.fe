import React, { useMemo, useState, useEffect } from "react";
import "./MyPageReservation.css";

import {
  fetchMyReservations,
  cancelReservation,
  type ApiReservation,
} from "../api/reservations";

import { useInterest } from "../contexts/InterestContext";

type ReservationStatus = "RESERVED" | "CANCELED";

type Reservation = {
  id: number;

  targetType: "HOSPITAL" | "FUNERAL";
  targetId: number;

  hospitalName: string;
  hospitalCategoryLabel: string;
  rating: number;
  reviewCount: number;

  reservationNumber: string;
  reservedDate: string;
  petName: string;
  petSpeciesSex: string;

  status: ReservationStatus;
};

function BookmarkIcon({ active }: { active: boolean }) {
  return (
    <svg
      width={18}
      height={18}
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        d="M6 3.5C6 2.67157 6.67157 2 7.5 2H16.5C17.3284 2 18 2.67157 18 3.5V22L12 18.5L6 22V3.5Z"
        fill="transparent"
        stroke={active ? "#FF0000" : "#000000"}
        strokeWidth={2.8}              
        vectorEffect="non-scaling-stroke"
        strokeLinejoin="round"
      />
    </svg>
  );
}



function StarIcon() {
  return (
    <svg width={18} height={18} viewBox="0 0 24 24">
      <path
        d="M12 2l2.92 6.62 7.08.62-5.35 4.64 1.6 6.96L12 17.77 5.75 20.84l1.6-6.96L2 9.24l7.08-.62L12 2z"
        fill="#FBBF24"
      />
    </svg>
  );
}

function dashToDot(date: string) {
  return date ? date.replaceAll("-", ".") : "";
}

function mapApiReservationToUI(api: ApiReservation): Reservation {
  return {
    id: api.reservationId,

    targetType: api.targetType,
    targetId: api.targetId,

    hospitalName: api.targetName ?? "-",
    hospitalCategoryLabel: api.targetType === "HOSPITAL" ? "동물병원" : "장례식장",

    rating: (api as any).ratingAvg ?? 0,
    reviewCount: (api as any).reviewCount ?? 0,

    reservationNumber: api.reservationNumber ?? "-",
    reservedDate: dashToDot(api.reservationDate),

    petName: api.petName ?? "-",
    petSpeciesSex: (api as any).petSpeciesSex ?? "-",

    status: api.status,
  };
}

export default function MyPageReservation() {
  const { isInterested, toggle } = useInterest();

  const [reservations, setReservations] = useState<Reservation[]>([]);
  const [loading, setLoading] = useState(false);

  const PAGE_SIZE = 3;
  const [page, setPage] = useState(1);

  const totalPages = Math.max(1, Math.ceil(reservations.length / PAGE_SIZE));

  const pageItems = useMemo(() => {
    const start = (page - 1) * PAGE_SIZE;
    return reservations.slice(start, start + PAGE_SIZE);
  }, [reservations, page]);

  useEffect(() => {
    if (page > totalPages) setPage(totalPages);
  }, [page, totalPages]);

  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        const data = await fetchMyReservations();
        setReservations((data ?? []).map(mapApiReservationToUI));
      } catch (e) {
        console.error(e);
        setReservations([]);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const handleCancelReservation = async (id: number) => {
    const ok = window.confirm("정말 예약을 취소하시겠습니까?");
    if (!ok) return;

    try {
      await cancelReservation(id);
      setReservations((prev) => prev.map((r) => (r.id === id ? { ...r, status: "CANCELED" } : r)));
    } catch (e) {
      console.error(e);
      alert("예약 취소에 실패했습니다.");
    }
  };

  const handleToggleBookmark = async (r: Reservation) => {
    try {
      await toggle(r.targetType, r.targetId);
    } catch (e) {
      console.error(e);
      alert("즐겨찾기 처리에 실패했습니다.");
    }
  };

  return (
    <section className="mp-main reservationBox">
      <div className="mp-box">
        <div className="mpr-header">
          <h2 className="mpr-title">예약 내역 관리</h2>
          <p className="mpr-desc">법적 진료내역 보관 기간은 최소 1년입니다.</p>
        </div>
        <div className="mpr-divider" />
      </div>

      {loading ? (
        <div className="reservation-list">
          <div className="wr-empty">불러오는 중...</div>
        </div>
      ) : reservations.length === 0 ? (
        <div className="reservation-list">
          <div className="wr-empty">예약 내역이 없습니다.</div>
        </div>
      ) : (
        <div className="reservation-list">
          {pageItems.map((r) => {
            const active = isInterested(r.targetType, r.targetId);

            return (
              <div className="reservation-card" key={r.id}>
                <div className="card-image">IMAGE</div>

                <div className="card-info">
                  <div className="card-title">
                    <div className="card-hospital-name">{r.hospitalName}</div>

                    <div className="card-rating">
                      <StarIcon />
                      <span>{r.rating}</span>
                      <span className="card-reviewcount">({r.reviewCount})</span>
                    </div>
                  </div>

                  <div className="card-sub">{r.hospitalCategoryLabel}</div>

                  <div className="card-line">
                    <div className="card-row">
                      <div className="card-label">예약번호</div>
                      <div className="card-value">{r.reservationNumber}</div>
                    </div>

                    <div className="card-row">
                      <div className="card-label">예약날짜</div>
                      <div className="card-value">{r.reservedDate}</div>
                    </div>

                    <div className="card-row">
                      <div className="card-label">반려동물</div>
                      <div className="card-value">
                        {r.petName} / {r.petSpeciesSex}
                      </div>
                    </div>

                    <div className="card-row">
                      <div className="card-label">상태</div>
                      <div className={`card-status ${r.status === "RESERVED" ? "reserved" : "canceled"}`}>
                        {r.status === "RESERVED" ? "예약완료" : "예약취소"}
                      </div>
                    </div>
                  </div>
                </div>

                <div className="card-actions">
                  <button
                    type="button"
                    className="bookmarkInlineBtn"
                    onClick={() => handleToggleBookmark(r)}
                    aria-label={active ? "즐겨찾기 해제" : "즐겨찾기 추가"}
                    title={active ? "즐겨찾기 해제" : "즐겨찾기 추가"}
                  >
                   <BookmarkIcon active={active} />
                  </button>

                  <button
                    className="cancel-btn"
                    onClick={() => handleCancelReservation(r.id)}
                    disabled={r.status === "CANCELED"}
                  >
                    예약취소
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {reservations.length > 0 && (
        <div className="pagination">
          {Array.from({ length: totalPages }).map((_, i) => (
            <button
              key={i}
              className={`page-btn ${page === i + 1 ? "active" : ""}`}
              onClick={() => setPage(i + 1)}
              type="button"
            >
              {i + 1}
            </button>.main {
  flex: 1;
  background: #ffffff;
  border-radius: 14px;
  border: 1px solid #e5e7eb;
  padding: 22px;
}

.main h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 900;
  color: #0f172a;
}

.main-desc {
  font-size: 12px;
  color: #94a3b8;
  margin-top: 6px;
}

.reservation-list {
  margin-top: 14px;
}

.reservation-card {
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 14px;
  display: flex;
  gap: 16px;
  margin-bottom: 14px;
}

.card-image {
  width: 150px;
  height: 110px;
  background: #f1f5f9;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #94a3b8;
  flex-shrink: 0;
}

.card-info {
  flex: 1;
  font-size: 13px;
  color: #0f172a;
}

.card-title {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.card-hospital-name {
  font-size: 18px;
  font-weight: 900;
  color: #0f172a;
}

.card-rating {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 900;
  color: #0f172a;
}

.card-reviewcount {
  color: #64748b;
  font-weight: 800;
}

.card-sub {
  margin-top: 6px;
  font-size: 12px;
  color: #94a3b8;
  font-weight: 800;
}

.card-line {
  margin-top: 10px;
  display: flex;
  gap: 16px;
  flex-direction: column;
}

.card-row {
  display: flex;
  gap: 12px;
  align-items: center;
}

.card-label {
  width: 70px;
  font-size: 12px;
  color: #94a3b8;
  font-weight: 900;
}

.card-value {
  font-size: 13px;
  color: #64748b;
  font-weight: 900;
}

.card-status.reserved {
  color: #2563eb;
  font-weight: 900;
}

.card-status.canceled {
  color: #ff0000;
  font-weight: 900;
}

.card-actions {
  width: 120px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  justify-content: space-between;
}

.bookmarkInlineBtn {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  border: none;
  background: transparent;
  display: grid;
  place-items: center;
  cursor: pointer;
  flex: 0 0 auto;
  margin-top: -2px; 
}

.bookmarkInlineBtn:hover,
.bookmarkInlineBtn:active,
.bookmarkInlineBtn:focus,
.bookmarkInlineBtn:focus-visible {
  background: transparent;
  outline: none;
}

.bookmarkInlineBtn svg {
  display: block;
}

.bookmarkInlineBtn svg path {
  fill: none;
  stroke-width: 1.5;
}

.cancel-btn {
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  background: #2eaadc;
  color: #ffffff;
  font-weight: 900;
  cursor: pointer;
}

.cancel-btn:disabled {
  background: #e2e8f0;
  cursor: not-allowed;
}

.pagination {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 16px;
}

.page-btn {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  background: #ffffff;
  font-weight: 900;
  cursor: pointer;

  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  padding: 0;
}

.page-btn.active {
  background: #2eaadc;
  color: #ffffff;
}

.mpr-desc {
  font-size: 12px;
  color: #94a3b8; 
  margin-top: 6px;
}

.mpr-divider {
  width: 100%;
  height: 1px;
  background: #e9eef4; 
  margin: 14px 0 16px; 
}


.mpr-header {
  margin-bottom: 0px;
}

.mpr-title {
  margin-top:0px;
  color:#64748B;
  font-size: 22px;
  font-weight: 800;
}

.mp-box {
  background: #f5f7fa;
  margin: -22px -26px 0;
  padding: 22px 26px 0px;
  border-radius: 12px 12px 0 0;
  border-color: #E9EEF4;
}

.mp-main.reservationBox {
  height: 800px; 
}
          ))}
        </div>
      )}
    </section>
  );
}